<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Types Multi-Select Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .car-types-multiselect {
            border: 1px solid #e1e5eb;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background-color: #fff;
        }
        
        .car-types-multiselect.is-invalid {
            border-color: #dc3545;
        }
        
        .car-types-grid .form-check {
            margin-bottom: 0.5rem;
        }
        
        .car-type-chips .badge {
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }
        
        .selected-car-types {
            border-top: 1px solid #e1e5eb;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Car Types Multi-Select Test</h2>
        <p class="text-muted">This test verifies the car types multi-select functionality works correctly.</p>
        
        <form>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="car_types" class="form-label">Car Types <span class="text-danger">*</span></label>
                    <div class="form-control-wrap">
                        <!-- Multi-select Car Types -->
                        <div class="car-types-multiselect" id="car-types-container">
                            <div class="car-types-grid row">
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input car-type-checkbox" 
                                               type="checkbox" 
                                               name="car_types[]" 
                                               value="SUV" 
                                               id="car_type_59"
                                               data-type-id="59">
                                        <label class="form-check-label" for="car_type_59">
                                            SUV
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input car-type-checkbox" 
                                               type="checkbox" 
                                               name="car_types[]" 
                                               value="hatchback" 
                                               id="car_type_60"
                                               data-type-id="60">
                                        <label class="form-check-label" for="car_type_60">
                                            hatchback
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input car-type-checkbox" 
                                               type="checkbox" 
                                               name="car_types[]" 
                                               value="MPV" 
                                               id="car_type_61"
                                               data-type-id="61">
                                        <label class="form-check-label" for="car_type_61">
                                            MPV
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input car-type-checkbox" 
                                               type="checkbox" 
                                               name="car_types[]" 
                                               value="Sedan" 
                                               id="car_type_62"
                                               data-type-id="62">
                                        <label class="form-check-label" for="car_type_62">
                                            Sedan
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Selected items display -->
                            <div class="selected-car-types mt-2" id="selected-car-types" style="display: none;">
                                <small class="text-muted">Selected:</small>
                                <div class="car-type-chips d-flex flex-wrap gap-1 mt-1"></div>
                            </div>
                        </div>
                        
                        <!-- Hidden field for backward compatibility -->
                        <input type="hidden" name="car_type" id="car_type_legacy">
                        
                        <small class="text-danger d-none" data-error="car_types">At least one car type must be selected.</small>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="validateSelection()">Validate Selection</button>
                <button type="button" class="btn btn-secondary" onclick="showSelectedValues()">Show Selected Values</button>
                <button type="button" class="btn btn-info" onclick="loadTestData()">Load Test Data (SUV, Sedan)</button>
            </div>
        </form>
        
        <div class="mt-4">
            <div id="validation-result" class="alert" style="display: none;"></div>
            <div id="selected-values" class="alert alert-info" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        // Car Types Multi-Select Functions
        function initializeCarTypesMultiSelect() {
            // Handle checkbox changes
            $('.car-type-checkbox').on('change', function() {
                updateSelectedCarTypes();
                updateBackwardCompatibility();
            });
            
            // Initialize display
            updateSelectedCarTypes();
        }
        
        function updateSelectedCarTypes() {
            const selectedChips = $('.car-type-chips');
            const selectedContainer = $('#selected-car-types');
            const checkedBoxes = $('.car-type-checkbox:checked');
            
            selectedChips.empty();
            
            if (checkedBoxes.length > 0) {
                selectedContainer.show();
                checkedBoxes.each(function() {
                    const label = $(this).next('label').text();
                    const chip = $(`<span class="badge bg-primary me-1">${label}</span>`);
                    selectedChips.append(chip);
                });
            } else {
                selectedContainer.hide();
            }
        }
        
        function updateBackwardCompatibility() {
            // Update legacy car_type field with first selected value for backward compatibility
            const firstChecked = $('.car-type-checkbox:checked').first();
            const legacyField = $('#car_type_legacy');
            
            if (firstChecked.length > 0) {
                const selectedValue = firstChecked.val();
                legacyField.val(selectedValue);
            } else {
                legacyField.val('');
            }
        }
        
        function validateSelection() {
            const checkedBoxes = $('.car-type-checkbox:checked');
            const errorElement = $('[data-error="car_types"]');
            const container = $('#car-types-container');
            const resultDiv = $('#validation-result');
            
            if (checkedBoxes.length === 0) {
                container.addClass('is-invalid');
                errorElement.removeClass('d-none');
                resultDiv.removeClass('alert-success').addClass('alert-danger').text('❌ Validation Failed: At least one car type must be selected.').show();
            } else {
                container.removeClass('is-invalid');
                errorElement.addClass('d-none');
                resultDiv.removeClass('alert-danger').addClass('alert-success').text('✅ Validation Passed: Car types selection is valid.').show();
            }
        }
        
        function showSelectedValues() {
            const checkedBoxes = $('.car-type-checkbox:checked');
            const legacyValue = $('#car_type_legacy').val();
            const resultDiv = $('#selected-values');
            
            let message = '<strong>Selected Car Types:</strong><br>';
            if (checkedBoxes.length > 0) {
                const values = [];
                checkedBoxes.each(function() {
                    values.push($(this).val());
                });
                message += `New format (car_types[]): ${values.join(', ')}<br>`;
                message += `Legacy format (car_type): ${legacyValue}`;
            } else {
                message += 'No car types selected';
            }
            
            resultDiv.html(message).show();
        }
        
        function loadTestData() {
            // Simulate loading existing listing with car types
            $('#car_type_59').prop('checked', true); // SUV
            $('#car_type_62').prop('checked', true); // Sedan
            updateSelectedCarTypes();
            updateBackwardCompatibility();
            
            $('#validation-result').removeClass('alert-danger').addClass('alert-info').text('📝 Test data loaded: SUV and Sedan selected').show();
        }
        
        // Initialize on document ready
        $(document).ready(function() {
            initializeCarTypesMultiSelect();
        });
    </script>
</body>
</html>