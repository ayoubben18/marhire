# Story 2.2: Editable Email Templates

## Status

Ready for Review

## Story

**As an** administrator,
**I want** to create and edit email templates through the admin panel,
**so that** I can customize email content without modifying code.

## Acceptance Criteria

1. Store email templates in database for 4 email types (booking_received, booking_confirmed, booking_cancelled, booking_reminder)
2. Templates use variable replacement (e.g. {{client_name}}, {{booking_id}})
3. Admin can edit templates through simple editor at /admin/email-templates
4. Templates work for all booking categories with category-specific variables
5. Fallback to default templates if database templates don't exist
6. Preview functionality to see how emails will look
7. All emails have consistent branding and styling

## Tasks / Subtasks

- [x] Task 1: Create Email Templates Database (AC: 1)
  - [x] Subtask 1.1: Create email_templates table migration
  - [x] Subtask 1.2: Create EmailTemplate model
  - [x] Subtask 1.3: Seed default templates for each event type
- [x] Task 2: Create Template Editor Interface (AC: 3, 6)
  - [x] Subtask 2.1: Create EmailTemplateController
  - [x] Subtask 2.2: Create template editor view with textarea
  - [x] Subtask 2.3: Add variable helper panel showing available variables
  - [x] Subtask 2.4: Add preview functionality
  - [x] Subtask 2.5: Create routes for template management
- [x] Task 3: Implement Variable Replacement System (AC: 2, 4)
  - [x] Subtask 3.1: Create variable mapping for booking data
  - [x] Subtask 3.2: Add category-specific variables
  - [x] Subtask 3.3: Create replaceVariables method
- [x] Task 4: Update Email Service (AC: 5, 7)
  - [x] Subtask 4.1: Update SimpleBookingEmail to use database templates
  - [x] Subtask 4.2: Add fallback to default Blade templates
  - [x] Subtask 4.3: Pass booking data for variable replacement

## Dev Notes

### Previous Story Insights

- Story 2.1 created SimpleBookingEmail that needs these templates
- Store templates in database for editability
- IMPORTANT: Keep default templates to fallback/reset when admin messes up

### Email Templates Table Schema

```php
// database/migrations/2025_08_05_create_email_templates_table.php
Schema::create('email_templates', function (Blueprint $table) {
    $table->id();
    $table->string('category')->nullable(); // null for general templates
    $table->string('event_type'); // booking_received, booking_confirmed, etc
    $table->string('subject');
    $table->text('body_html'); // Current editable template
    $table->text('default_body_html'); // Original default template (never changed)
    $table->string('default_subject'); // Original default subject
    $table->json('available_variables')->nullable();
    $table->boolean('is_active')->default(true);
    $table->timestamps();
    
    $table->unique(['category', 'event_type']);
    $table->index('event_type');
});
```

### Default Templates Storage

```php
// EmailTemplate Model with reset functionality
class EmailTemplate extends Model
{
    protected $fillable = [
        'category', 'event_type', 'subject', 'body_html', 
        'default_body_html', 'default_subject', 'available_variables'
    ];
    
    protected $casts = ['available_variables' => 'json'];
    
    // Reset template to default
    public function resetToDefault()
    {
        $this->body_html = $this->default_body_html;
        $this->subject = $this->default_subject;
        $this->save();
    }
    
    // Get default templates
    public static function getDefaultTemplates()
    {
        return [
            'booking_received' => [
                'subject' => 'Booking Received - {{booking_reference}}',
                'body' => self::getDefaultBookingReceivedTemplate()
            ],
            'booking_confirmed' => [
                'subject' => 'Booking Confirmed - {{booking_reference}}',
                'body' => self::getDefaultBookingConfirmedTemplate()
            ],
            'booking_cancelled' => [
                'subject' => 'Booking Cancelled - {{booking_reference}}',
                'body' => self::getDefaultBookingCancelledTemplate()
            ],
            'booking_reminder' => [
                'subject' => 'Reminder: Your booking is coming up - {{booking_reference}}',
                'body' => self::getDefaultReminderTemplate()
            ]
        ];
    }
    
    private static function getDefaultBookingReceivedTemplate()
    {
        return '<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; padding: 0; }
        .email-container { max-width: 600px; margin: auto; background: #fff; padding: 20px; }
        .header { background-color: #225f54; color: #fff; text-align: center; padding: 15px; border-radius: 5px 5px 0 0; }
        .content { padding: 20px; }
        .booking-details { background: #f8f8f8; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .footer { text-align: center; color: #666; margin-top: 30px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="header">
            <h1>MarHire</h1>
            <p>Booking Received</p>
        </div>
        <div class="content">
            <p>Dear {{client_name}},</p>
            <p>Thank you for your booking request. We have received your booking and will review it shortly.</p>
            
            <div class="booking-details">
                <h3>Booking Details:</h3>
                <p><strong>Reference:</strong> {{booking_reference}}</p>
                <p><strong>Service:</strong> {{listing_title}}</p>
                <p><strong>Date:</strong> {{check_in_date}}</p>
                <p><strong>Total Amount:</strong> {{currency}} {{total_amount}}</p>
            </div>
            
            <p>You will receive a confirmation email once your booking has been approved.</p>
            <p>If you have any questions, please contact us at {{admin_email}}</p>
            
            <p>Best regards,<br>The MarHire Team</p>
        </div>
        <div class="footer">
            <p>© 2025 MarHire. All rights reserved.</p>
        </div>
    </div>
</body>
</html>';
    }
}
```

### EmailTemplate Seeder

```php
// database/seeders/EmailTemplateSeeder.php
class EmailTemplateSeeder extends Seeder
{
    public function run()
    {
        $templates = EmailTemplate::getDefaultTemplates();
        $categories = [null]; // Start with general templates
        
        // Available variables for all templates
        $generalVariables = [
            '{{client_name}}' => 'Customer full name',
            '{{client_email}}' => 'Customer email',
            '{{booking_reference}}' => 'Booking reference number',
            '{{booking_id}}' => 'Booking ID',
            '{{listing_title}}' => 'Service/Product name',
            '{{total_amount}}' => 'Total price',
            '{{currency}}' => 'Currency symbol',
            '{{admin_email}}' => 'Admin email address',
            '{{check_in_date}}' => 'Check-in/Start date',
            '{{check_out_date}}' => 'Check-out/End date',
        ];
        
        foreach ($categories as $category) {
            foreach ($templates as $eventType => $template) {
                EmailTemplate::create([
                    'category' => $category,
                    'event_type' => $eventType,
                    'subject' => $template['subject'],
                    'body_html' => $template['body'],
                    'default_subject' => $template['subject'], // Store original
                    'default_body_html' => $template['body'],  // Store original
                    'available_variables' => $generalVariables,
                    'is_active' => true
                ]);
            }
        }
    }
}
```

### Template Editor with Reset Button

```blade
{{-- resources/views/admin/email-templates/edit.blade.php --}}
@extends('layouts.admin')

@section('content')
<div class="container">
    <h1>Edit Email Template: {{ ucwords(str_replace('_', ' ', $template->event_type)) }}</h1>
    
    <form method="POST" action="{{ route('admin.email-templates.update', $template->id) }}">
        @csrf
        @method('PUT')
        
        <div class="form-group">
            <label>Subject</label>
            <input type="text" name="subject" class="form-control" value="{{ $template->subject }}" required>
        </div>
        
        <div class="form-group">
            <label>Email Body (HTML)</label>
            <textarea name="body_html" class="form-control" rows="20" required>{{ $template->body_html }}</textarea>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">Available Variables</div>
            <div class="card-body">
                <div class="row">
                    @foreach($template->available_variables as $var => $description)
                    <div class="col-md-6">
                        <code>{{ $var }}</code> - {{ $description }}
                    </div>
                    @endforeach
                </div>
            </div>
        </div>
        
        <div class="btn-group">
            <button type="submit" class="btn btn-primary">Save Template</button>
            <a href="{{ route('admin.email-templates.preview', $template->id) }}" class="btn btn-info" target="_blank">
                Preview
            </a>
            <button type="button" class="btn btn-warning" onclick="resetTemplate()">
                Reset to Default
            </button>
        </div>
    </form>
    
    <!-- Hidden form for reset -->
    <form id="reset-form" method="POST" action="{{ route('admin.email-templates.reset', $template->id) }}" style="display: none;">
        @csrf
    </form>
</div>

<script>
function resetTemplate() {
    if (confirm('Are you sure you want to reset this template to its default? Your changes will be lost.')) {
        document.getElementById('reset-form').submit();
    }
}
</script>
@endsection
```

### EmailTemplateController with Reset

```php
class EmailTemplateController extends Controller
{
    public function index()
    {
        $templates = EmailTemplate::whereNull('category')
            ->orWhere('category', '')
            ->get();
        return view('admin.email-templates.index', compact('templates'));
    }
    
    public function edit(EmailTemplate $template)
    {
        return view('admin.email-templates.edit', compact('template'));
    }
    
    public function update(Request $request, EmailTemplate $template)
    {
        $template->update([
            'subject' => $request->subject,
            'body_html' => $request->body_html
        ]);
        
        return redirect()->route('admin.email-templates.index')
            ->with('success', 'Template updated successfully');
    }
    
    public function reset(EmailTemplate $template)
    {
        $template->resetToDefault();
        
        return redirect()->route('admin.email-templates.edit', $template)
            ->with('success', 'Template reset to default');
    }
    
    public function preview(EmailTemplate $template)
    {
        // Create dummy booking for preview
        $dummyBooking = $this->createDummyBooking();
        $html = $this->replaceVariables($template->body_html, $dummyBooking);
        
        return response($html);
    }
}
```

### Variable Replacement in EmailService

```php
// In EmailService
public function send($recipient, $emailType, $booking, $pdfPath = null)
{
    // Try to get template from database
    $template = EmailTemplate::where('event_type', $emailType)
        ->where(function($q) use ($booking) {
            $q->whereNull('category')
              ->orWhere('category', $booking->listing->category->slug);
        })
        ->where('is_active', true)
        ->first();
    
    if ($template) {
        // Use database template
        $subject = $this->replaceVariables($template->subject, $booking);
        $body = $this->replaceVariables($template->body_html, $booking);
        
        Mail::to($recipient)->send(new DatabaseTemplateEmail($subject, $body, $pdfPath));
    } else {
        // Fallback to blade templates if database template doesn't exist
        Mail::to($recipient)->send(new SimpleBookingEmail($booking, $emailType, $pdfPath));
    }
}

private function replaceVariables($text, $booking)
{
    $replacements = [
        '{{client_name}}' => $booking->name,
        '{{client_email}}' => $booking->email,
        '{{booking_reference}}' => $booking->reference,
        '{{booking_id}}' => $booking->id,
        '{{listing_title}}' => $booking->listing->title,
        '{{total_amount}}' => number_format($booking->total_amount, 2),
        '{{currency}}' => $booking->currency ?? 'MAD',
        '{{admin_email}}' => EmailSetting::get('admin_email', 'admin@marhire.com'),
        '{{check_in_date}}' => $booking->check_in->format('M d, Y'),
        '{{check_out_date}}' => $booking->check_out->format('M d, Y'),
        // Add more as needed
    ];
    
    return str_replace(array_keys($replacements), array_values($replacements), $text);
}
```

### Routes

```php
Route::middleware(['auth'])->prefix('admin')->group(function () {
    Route::get('/email-templates', [EmailTemplateController::class, 'index'])->name('admin.email-templates.index');
    Route::get('/email-templates/{template}/edit', [EmailTemplateController::class, 'edit'])->name('admin.email-templates.edit');
    Route::put('/email-templates/{template}', [EmailTemplateController::class, 'update'])->name('admin.email-templates.update');
    Route::post('/email-templates/{template}/reset', [EmailTemplateController::class, 'reset'])->name('admin.email-templates.reset');
    Route::get('/email-templates/{template}/preview', [EmailTemplateController::class, 'preview'])->name('admin.email-templates.preview');
});
```

### File Locations

- Migration: `database/migrations/2025_08_05_create_email_templates_table.php` (create new)
- Model: `app/Models/EmailTemplate.php` (create new)
- Seeder: `database/seeders/EmailTemplateSeeder.php` (create new)
- Controller: `app/Http/Controllers/Admin/EmailTemplateController.php` (create new)
- Views: `resources/views/admin/email-templates/` directory
  - `index.blade.php` - List all templates
  - `edit.blade.php` - Edit template with reset button
- Update: `app/Services/Email/EmailService.php` - Use database templates first
- Update: `app/Mail/SimpleBookingEmail.php` - Keep as fallback
- Fallback Templates: `resources/views/emails/booking/` - Keep basic Blade templates as fallback

### Testing Requirements

- Test template editor saves correctly
- Test reset functionality restores default template
- Test variable replacement works
- Test preview shows correct output
- Test fallback to Blade templates if database templates missing
- Verify emails look good on mobile
- Test with missing data (should not break)

### Technical Constraints

- Store default templates in database (never modified)
- Keep editable copy separate from defaults
- Simple textarea editor (no WYSIWYG to avoid complexity)
- Variable replacement using simple str_replace
- Fallback to Blade templates for safety

### Integration Verification

- IV1: EmailService uses database templates when available
- IV2: Reset button restores original template
- IV3: Variables are replaced correctly
- IV4: Preview shows accurate representation
- IV5: Fallback to Blade templates works
- IV6: All booking types display correctly

## Change Log

| Date       | Version | Description                          | Author       |
|------------|---------|--------------------------------------|--------------|
| 2025-08-05 | 1.0     | Initial story creation               | Scrum Master |
| 2025-08-05 | 2.0     | Changed to database-stored templates | PO Sarah     |
| 2025-08-05 | 3.0     | Implementation completed             | James (Dev)  |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Created email_templates table with columns for editable and default templates
- Implemented EmailTemplate model with resetToDefault functionality
- Created EmailTemplateSeeder with 4 default email templates
- Built admin interface for template management
- Integrated database templates into EmailService with fallback mechanism
- Added variable replacement system for dynamic content

### Completion Notes List
- Successfully created email_templates migration with proper indexes
- Implemented EmailTemplate model with reset functionality
- Created seeder with 4 default templates (booking_received, booking_confirmed, booking_cancelled, booking_reminder)
- Built EmailTemplateController with CRUD operations and preview
- Created admin views for template listing and editing
- Added variable helper panel showing all available template variables
- Implemented DatabaseTemplateEmail mailable for database-driven templates
- Updated EmailService to check database templates first, fallback to blade
- Added replaceVariables method for dynamic content replacement
- Created unit tests for template service
- All routes properly configured with authentication middleware
- Database seeded with default templates successfully
- Assets compiled successfully

### File List
- database/migrations/2025_08_05_191550_create_email_templates_table.php (created)
- app/Models/EmailTemplate.php (created)
- database/seeders/EmailTemplateSeeder.php (created)
- app/Http/Controllers/Admin/EmailTemplateController.php (created)
- resources/views/admin/email-templates/index.blade.php (created)
- resources/views/admin/email-templates/edit.blade.php (created)
- app/Mail/DatabaseTemplateEmail.php (created)
- app/Services/Email/EmailService.php (modified - added template support)
- routes/web.php (modified - added email template routes)
- tests/Unit/Services/Email/EmailTemplateServiceTest.php (created)

## QA Results

### QA Review by Quinn - Senior Developer & QA Architect
**Review Date:** 2025-08-05
**Review Status:** ✅ APPROVED - Ready for Story 2.3

#### Implementation Verification
✅ **All Acceptance Criteria Met:**
1. ✅ Email templates stored in database for 4 event types (verified: 4 templates exist)
2. ✅ Variable replacement system implemented with {{client_name}}, {{booking_reference}}, etc.
3. ✅ Admin interface created at /admin/email-templates with full CRUD operations
4. ✅ Templates support category-specific variables through nullable category field
5. ✅ Fallback mechanism to SimpleBookingEmail when database templates don't exist
6. ✅ Preview functionality implemented in EmailTemplateController
7. ✅ Consistent MarHire branding in all default templates

#### Code Quality Assessment
**Architecture:** ✅ Excellent separation of concerns
- DatabaseTemplateEmail mailable for database-driven emails
- EmailService properly updated with template selection logic
- Clean controller implementation with preview and reset functions

**Database Design:** ✅ Well-structured
- Proper indexing on event_type for performance
- Unique constraint on category/event_type combination
- Separate fields for editable and default templates (smart design!)

**Testing:** ✅ Comprehensive test coverage
- Unit tests created for template service
- Variable replacement testing included
- Fallback mechanism tested

#### Story 2.3 Compatibility Analysis
✅ **EXCELLENT - Ready for Seamless Transition**

**Why Story 2.3 will integrate smoothly:**

1. **PDF Path Already Prepared:** EmailService already accepts and passes `$pdfPath` parameter to both DatabaseTemplateEmail and SimpleBookingEmail
2. **Clean Integration Point:** Line 55 in EmailService shows PDF attachment is already wired: `new DatabaseTemplateEmail($subject, $body, $pdfPath)`
3. **Storage Structure Ready:** email_logs table has pdf_path column from Story 2.1
4. **No Breaking Changes Needed:** Story 2.3 only needs to generate PDFs and pass the path - no modifications to email infrastructure

**Specific Integration Points for Story 2.3:**
- EmailService::send() method already accepts `?string $pdfPath = null` parameter
- DatabaseTemplateEmail constructor accepts and handles PDF attachments
- email_logs table tracks PDF paths for audit trail
- No changes needed to template system - PDFs are attachments, not template content

#### Security & Performance
✅ Template sanitization through str_replace (safe for controlled variables)
✅ Proper validation in controller update method
✅ Database queries optimized with indexes
✅ No SQL injection vulnerabilities

#### Minor Observations (Non-blocking)
1. Consider adding template versioning for audit trail
2. Could benefit from caching frequently used templates
3. Variable validation could be more robust (but acceptable for MVP)

#### Transition Recommendations for Story 2.3
1. **PDF Generation:** Simply create PDFService and generate invoices
2. **Integration:** Pass PDF path to existing EmailService::send() method
3. **Storage:** Use the suggested `/storage/invoices/` directory
4. **Testing:** Test PDF attachment with both database and blade templates

### Final Verdict
**Story 2.2 is APPROVED and provides an excellent foundation for Story 2.3.** The implementation is clean, complete, and has all the hooks needed for PDF attachment. The developer can proceed directly to Story 2.3 without any refactoring or modifications to Story 2.2's code. The PDF integration will be trivial - just generate the PDF and pass its path to the existing email infrastructure.