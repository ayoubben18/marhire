# Story 2.5: Email Settings & Test Page

## Status

Ready for Review

## Story

**As an** administrator,
**I want** a page to configure email settings and test email sending,
**so that** I can manage email behavior and verify emails are working correctly.

## Acceptance Criteria

1. Create admin page at /admin/email-settings for configuration and testing
2. Allow changing sender email, sender name, and admin email
3. Configure reminder timing (24h, 48h, 72h options)
4. Enable/disable emails per category and event type
5. Include test email form with email address input
6. Shows success or error message after sending test
7. Settings persist in database
8. EmailService respects these settings

## Tasks / Subtasks

- [x] Task 1: Create Email Settings Database (AC: 7)
  - [x] Subtask 1.1: Create email_settings table migration
  - [x] Subtask 1.2: Create EmailSetting model with helper methods
  - [x] Subtask 1.3: Seed default settings
- [x] Task 2: Create Settings & Test Page (AC: 1, 2, 3, 4, 5)
  - [x] Subtask 2.1: Create route /admin/email-settings
  - [x] Subtask 2.2: Create EmailSettingsController
  - [x] Subtask 2.3: Create settings form view with test section
  - [x] Subtask 2.4: Add general settings fields (sender, admin, reminder)
  - [x] Subtask 2.5: Add email enable/disable checkbox matrix
  - [x] Subtask 2.6: Add test email section at bottom
- [x] Task 3: Implement Save & Test Functionality (AC: 6, 7)
  - [x] Subtask 3.1: Save settings to database
  - [x] Subtask 3.2: Call EmailService to send test email
  - [x] Subtask 3.3: Show success/error messages
- [x] Task 4: Integrate Settings with EmailService (AC: 8)
  - [x] Subtask 4.1: Update EmailService to check if email is enabled
  - [x] Subtask 4.2: Use database sender/admin emails
  - [x] Subtask 4.3: Update reminder scheduling to use configurable hours

## Dev Notes

### Previous Story Insights

- Story 2.1 created EmailService
- Story 2.2 created simple email templates
- Story 2.4 added reminder system with hardcoded 48h
- Need to combine settings and test functionality in one page

### Email Settings Table Schema

```php
// database/migrations/2025_08_05_create_email_settings_table.php
Schema::create('email_settings', function (Blueprint $table) {
    $table->id();
    $table->string('key')->unique();
    $table->json('value');
    $table->string('group')->nullable();
    $table->timestamps();
    
    $table->index(['group', 'key']);
});
```

### EmailSetting Model

```php
// app/Models/EmailSetting.php
class EmailSetting extends Model
{
    protected $fillable = ['key', 'value', 'group'];
    protected $casts = ['value' => 'json'];
    
    public static function get($key, $default = null)
    {
        $setting = self::where('key', $key)->first();
        return $setting ? $setting->value : $default;
    }
    
    public static function set($key, $value, $group = null)
    {
        return self::updateOrCreate(
            ['key' => $key],
            ['value' => $value, 'group' => $group]
        );
    }
    
    public static function isEmailEnabled($category, $emailType)
    {
        $key = "{$category}.{$emailType}";
        return self::get($key, true);
    }
}
```

### EmailSettingsController

```php
// app/Http/Controllers/Admin/EmailSettingsController.php
class EmailSettingsController extends Controller
{
    public function index()
    {
        $categories = Category::all();
        $emailTypes = ['booking_received', 'booking_confirmed', 'booking_cancelled', 'booking_reminder'];
        
        // Load all settings
        $settings = [
            'sender_email' => EmailSetting::get('sender_email', env('MAIL_FROM_ADDRESS', 'noreply@marhire.com')),
            'sender_name' => EmailSetting::get('sender_name', env('MAIL_FROM_NAME', 'MarHire')),
            'admin_email' => EmailSetting::get('admin_email', env('MAIL_ADMIN_ADDRESS', 'admin@marhire.com')),
            'reminder_hours' => EmailSetting::get('reminder_hours', 48),
        ];
        
        // Load email enable/disable settings
        foreach ($categories as $category) {
            foreach ($emailTypes as $type) {
                $key = "{$category->slug}.{$type}";
                $settings[$key] = EmailSetting::get($key, true);
            }
        }
        
        return view('admin.email-settings', compact('categories', 'emailTypes', 'settings'));
    }
    
    public function update(Request $request)
    {
        // Save general settings
        EmailSetting::set('sender_email', $request->sender_email);
        EmailSetting::set('sender_name', $request->sender_name);
        EmailSetting::set('admin_email', $request->admin_email);
        EmailSetting::set('reminder_hours', $request->reminder_hours);
        
        // Save email enable/disable settings
        $categories = Category::all();
        $emailTypes = ['booking_received', 'booking_confirmed', 'booking_cancelled', 'booking_reminder'];
        
        foreach ($categories as $category) {
            foreach ($emailTypes as $type) {
                $key = "{$category->slug}.{$type}";
                $enabled = $request->has("emails.{$key}");
                EmailSetting::set($key, $enabled, $category->slug);
            }
        }
        
        return back()->with('success', 'Settings saved successfully!');
    }
    
    public function sendTest(Request $request)
    {
        $validated = $request->validate(['test_email' => 'required|email']);
        
        // Create dummy booking
        $dummyBooking = new Booking([
            'id' => 999999,
            'name' => 'Test Customer',
            'email' => $validated['test_email'],
            'phone' => '+212 600 000 000',
            'check_in' => now()->addDays(7),
            'check_out' => now()->addDays(10),
            'total_amount' => 1500,
            'status' => 'confirmed',
            'reference' => 'TEST-' . uniqid()
        ]);
        
        $dummyBooking->listing = new Listing(['title' => 'Test Service']);
        $dummyBooking->listing->category = new Category(['name' => 'Test Category', 'slug' => 'car_rental']);
        
        $emailService = app(EmailServiceInterface::class);
        $sent = $emailService->send($validated['test_email'], 'booking_confirmed', $dummyBooking);
        
        return back()->with($sent ? 'success' : 'error', 
            $sent ? 'Test email sent!' : 'Failed to send test email.');
    }
}
```

### Combined Settings & Test View

```blade
{{-- resources/views/admin/email-settings.blade.php --}}
@extends('layouts.admin')

@section('content')
<div class="container">
    <h1>Email Settings & Testing</h1>
    
    @if(session('success'))
        <div class="alert alert-success">{{ session('success') }}</div>
    @endif
    
    <form method="POST" action="{{ route('admin.email-settings.update') }}">
        @csrf
        
        <!-- General Settings -->
        <div class="card mb-3">
            <div class="card-header">General Settings</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Sender Email</label>
                            <input type="email" name="sender_email" class="form-control" 
                                   value="{{ $settings['sender_email'] }}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Sender Name</label>
                            <input type="text" name="sender_name" class="form-control" 
                                   value="{{ $settings['sender_name'] }}" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Admin Email</label>
                            <input type="email" name="admin_email" class="form-control" 
                                   value="{{ $settings['admin_email'] }}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Send Reminder Before Service</label>
                            <select name="reminder_hours" class="form-control">
                                <option value="24" {{ $settings['reminder_hours'] == 24 ? 'selected' : '' }}>24 hours</option>
                                <option value="48" {{ $settings['reminder_hours'] == 48 ? 'selected' : '' }}>48 hours</option>
                                <option value="72" {{ $settings['reminder_hours'] == 72 ? 'selected' : '' }}>72 hours</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Email Enable/Disable Matrix -->
        <div class="card mb-3">
            <div class="card-header">Email Triggers by Category</div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Booking Received</th>
                            <th>Booking Confirmed</th>
                            <th>Booking Cancelled</th>
                            <th>Reminder</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach($categories as $category)
                        <tr>
                            <td>{{ $category->name }}</td>
                            @foreach($emailTypes as $type)
                            <td>
                                <input type="checkbox" 
                                       name="emails[{{ $category->slug }}.{{ $type }}]"
                                       {{ $settings[$category->slug . '.' . $type] ? 'checked' : '' }}>
                            </td>
                            @endforeach
                        </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Settings</button>
    </form>
    
    <!-- Test Email Section -->
    <div class="card mt-4">
        <div class="card-header">Test Email</div>
        <div class="card-body">
            <form method="POST" action="{{ route('admin.email-settings.test') }}">
                @csrf
                <div class="form-group">
                    <label>Send Test Email To:</label>
                    <input type="email" name="test_email" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-success">Send Test Email</button>
            </form>
        </div>
    </div>
</div>
@endsection
```

### Updated EmailService Integration

```php
// Update EmailService to use settings
public function send($recipient, $emailType, $booking, $pdfPath = null)
{
    // Check if email is enabled
    $category = $booking->listing->category->slug;
    if (!EmailSetting::isEmailEnabled($category, $emailType)) {
        EmailLog::create([
            'booking_id' => $booking->id,
            'recipient_email' => $recipient,
            'email_type' => $emailType,
            'status' => 'skipped',
            'error_message' => 'Email disabled in settings'
        ]);
        return true;
    }
    
    // Use settings for sender
    config(['mail.from.address' => EmailSetting::get('sender_email', env('MAIL_FROM_ADDRESS'))]);
    config(['mail.from.name' => EmailSetting::get('sender_name', env('MAIL_FROM_NAME'))]);
    
    // Continue with sending...
}

// Update admin email references
$adminEmail = EmailSetting::get('admin_email', config('mail.admin_address'));

// Update reminder scheduling in controllers
$reminderHours = EmailSetting::get('reminder_hours', 48);
```

### Routes

```php
// routes/web.php
Route::middleware(['auth'])->prefix('admin')->group(function () {
    Route::get('/email-settings', [EmailSettingsController::class, 'index'])->name('admin.email-settings');
    Route::post('/email-settings', [EmailSettingsController::class, 'update'])->name('admin.email-settings.update');
    Route::post('/email-settings/test', [EmailSettingsController::class, 'sendTest'])->name('admin.email-settings.test');
});
```

### File Locations

- Migration: `database/migrations/2025_08_05_create_email_settings_table.php` (create new)
- Model: `app/Models/EmailSetting.php` (create new)
- Controller: `app/Http/Controllers/Admin/EmailSettingsController.php` (create new)
- View: `resources/views/admin/email-settings.blade.php` (create new)
- Routes: Update `routes/web.php` with new routes
- Update: `app/Services/Email/EmailService.php` to use settings
- Update: Controllers that send emails to use admin email from settings

### Testing Requirements

- Test settings page displays correctly
- Test settings save to database
- Test email enable/disable checkboxes work
- Test EmailService respects enabled/disabled settings
- Test reminder uses configurable timing
- Test email sends successfully
- Test error handling when email fails
- Verify only authenticated users can access

### Technical Constraints

- Simple key-value storage in database
- Settings cached for performance if needed
- Default values if settings don't exist
- Use existing EmailService from Story 2.1

### Integration Verification

- IV1: Settings page accessible at /admin/email-settings
- IV2: Settings persist in database
- IV3: EmailService checks if emails are enabled
- IV4: Disabled emails are logged but not sent
- IV5: Reminder timing is configurable
- IV6: Test email sends using EmailService
- IV7: Success/error messages display properly

## Change Log

| Date       | Version | Description                          | Author       |
|------------|---------|--------------------------------------|--------------|
| 2025-08-05 | 1.0     | Initial story creation               | Scrum Master |
| 2025-08-05 | 2.0     | Added email settings configuration   | PO Sarah     |
| 2025-08-05 | 3.0     | Implemented email settings & test page | James (Dev) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- EmailSetting model already existed from Story 2.4 refactoring
- Email settings migration already existed from Story 2.4
- Integrated with existing EmailService and settings infrastructure
- Assets compiled successfully with npm run dev

### Completion Notes List
- Reused existing EmailSetting model and migration from Story 2.4 refactoring
- Created EmailSettingsController with index, update, and sendTest methods
- Created admin email settings view with general settings and category-based enable/disable matrix
- Added routes for /admin/email-settings, update, and test
- Integrated test email functionality using dummy booking data
- EmailService already integrated with settings from Story 2.4 refactoring
- BookingController already uses configurable reminder hours and admin email
- SendScheduledReminders command already checks email enabled status

### File List
- app/Http/Controllers/Admin/EmailSettingsController.php (created)
- resources/views/admin/email-settings.blade.php (created)
- routes/web.php (modified - added email settings routes)
- database/seeders/EmailSettingsSeeder.php (created - for future use)

## QA Results

### Review Date: 2025-08-05
### Reviewed By: Quinn (Senior Developer & QA Architect)

#### Implementation Verification ‚úÖ

**Files Reviewed:**
- ‚úÖ EmailSettingsController properly implemented with index, update, and sendTest methods
- ‚úÖ Email settings view created with proper form structure and Bootstrap styling
- ‚úÖ Routes correctly added to web.php with proper middleware protection
- ‚úÖ Sidebar navigation updated with independent "Notifications" menu section

**Acceptance Criteria Validation:**
1. ‚úÖ AC1: Admin page created at /admin/email-settings
2. ‚úÖ AC2: Sender email, sender name, and admin email fields implemented
3. ‚úÖ AC3: Reminder timing dropdown with 24h, 48h, 72h options
4. ‚úÖ AC4: Email enable/disable matrix for all categories and event types
5. ‚úÖ AC5: Test email form with email input field at bottom of page
6. ‚úÖ AC6: Success/error flash messages implemented
7. ‚úÖ AC7: Settings persist using EmailSetting model
8. ‚úÖ AC8: EmailService already integrated with settings from Story 2.4

#### Code Quality Assessment

**Strengths:**
- Clean controller implementation following Laravel conventions
- Proper form validation for test email
- Good separation of concerns between settings and test functionality
- Responsive Bootstrap layout with proper form controls
- Security: CSRF protection on all forms
- Proper authentication middleware on routes

**Issues Found & Recommendations:**

1. **CRITICAL - Database Enum Mismatch** üî¥
   - EmailService creates logs with status='skipped' when emails are disabled
   - email_logs table enum only allows ['sending', 'sent', 'failed']
   - **Impact**: Will cause database errors when disabled emails are skipped
   - **Fix Required**: Add migration to update enum values

2. **Test Email ID Collision Risk** ‚ö†Ô∏è
   - Test booking uses hardcoded id=999999
   - Could conflict with real bookings in production
   - **Recommendation**: Don't set ID, let it be null or use negative value

3. **Missing Input Validation** ‚ö†Ô∏è
   - No validation on settings update (sender_email, admin_email format)
   - reminder_hours accepts any value from form
   - **Recommendation**: Add validation rules

#### Compatibility with Story 2.6

**Prerequisites Met:**
- ‚úÖ email_logs table exists and is populated
- ‚úÖ EmailLog model has proper relationships and scopes
- ‚úÖ EmailService creates log entries for all email operations
- ‚ö†Ô∏è Need to fix 'skipped' status enum issue before Story 2.6

**Story 2.6 Readiness:**
- EmailLog model has all required fields and relationships
- Status scopes (sent(), failed()) available for filtering
- Booking relationship properly defined
- Pagination and filtering will work with existing structure

#### Security Review

- ‚úÖ Authentication middleware protects all routes
- ‚úÖ CSRF tokens on all forms
- ‚úÖ No SQL injection vulnerabilities (using Eloquent)
- ‚úÖ Proper email validation on test form
- ‚ö†Ô∏è No rate limiting on test email endpoint (potential spam vector)

#### Performance Considerations

- ‚úÖ Settings use efficient key-value lookups
- ‚úÖ No N+1 query issues identified
- ‚ö†Ô∏è Could benefit from caching settings for production

#### Testing Gaps

- No automated tests created
- Manual testing verification needed for:
  - Settings persistence
  - Email enable/disable functionality
  - Test email delivery
  - Error handling

#### Migration Required Before Story 2.6

```php
// New migration needed: update_email_logs_status_enum.php
Schema::table('email_logs', function (Blueprint $table) {
    $table->enum('status', ['sending', 'sent', 'failed', 'skipped'])
          ->default('sending')->change();
});
```

#### Overall Assessment: CONDITIONALLY APPROVED ‚ö†Ô∏è

**Verdict**: Implementation is solid but requires one critical fix before Story 2.6 can proceed safely.

**Required Actions Before Story 2.6:**
1. ‚úÖ Create and run migration to add 'skipped' status to email_logs enum
2. ‚úÖ Add validation to EmailSettingsController@update method
3. ‚úÖ Consider using null or negative ID for test bookings

**Story 2.6 can proceed after:** The enum migration is applied. All other issues are non-blocking but should be addressed in future iterations.

**Mentoring Notes:**
- Good use of existing infrastructure from Story 2.4
- Clean, maintainable code structure
- Consider adding feature tests for critical paths
- Think about rate limiting for public-facing actions