# Story 2.11: Email Status Dialog with Retry Functionality

## Status

Ready for Development

## Story

**As an** admin user,
**I want** to see the email sending status in a dialog and be able to retry failed emails,
**so that** I can track email delivery and ensure customers receive their notifications.

## Acceptance Criteria

1. Dialog shows complete email history for the booking
2. Display timestamp for each email sent
3. Show status with appropriate colors (Sent=green, Failed=red, Pending=orange, Not Sent=gray)
4. Display error message for failed emails
5. Allow retry for failed or unsent emails (max 3 attempts with configurable delay)
6. Show "Email already sent on [date]" with option to resend
7. Real-time status update after sending/retrying
8. Show recipient email address for each email type
9. Display PDF attachment status for confirmed bookings
10. Support only three email types (booking_received, booking_confirmed, booking_cancelled) - NO reminder emails in modal

## Tasks / Subtasks

- [ ] Task 1: Enhanced Email Status Display (AC: 1, 2, 3, 8)
  - [ ] Subtask 1.1: Create detailed email history query including all attempts
  - [ ] Subtask 1.2: Format timestamps in user-friendly format
  - [ ] Subtask 1.3: Add recipient email display for each log entry
  - [ ] Subtask 1.4: Sort history by most recent first
- [ ] Task 2: Error Display and Handling (AC: 4)
  - [ ] Subtask 2.1: Display error messages from email_logs table
  - [ ] Subtask 2.2: Format technical errors in user-friendly way
  - [ ] Subtask 2.3: Add tooltip or expandable section for full error details
- [ ] Task 3: Retry Mechanism (AC: 5, 6)
  - [ ] Subtask 3.1: Add "Retry" button for failed emails
  - [ ] Subtask 3.2: Add "Resend" button for already sent emails
  - [ ] Subtask 3.3: Implement retry counter with max 3 attempts
  - [ ] Subtask 3.4: Add configurable delay between retry attempts
  - [ ] Subtask 3.5: Update retry_count in email_logs table
- [ ] Task 4: Real-time Updates (AC: 7, 9)
  - [ ] Subtask 4.1: Use AJAX to update dialog without closing
  - [ ] Subtask 4.2: Show loading spinner during email sending
  - [ ] Subtask 4.3: Display success/failure toast notifications
  - [ ] Subtask 4.4: Refresh email history after action
  - [ ] Subtask 4.5: Show PDF attachment indicator when present

## Dev Notes

### Enhanced Dialog Structure:

```html
<div class="modal fade" id="emailStatusModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Email Management - Booking #<span id="bookingId"></span>
        </h5>
        <button type="button" class="close" data-dismiss="modal">Ã—</button>
      </div>
      
      <div class="modal-body">
        <!-- Customer Info -->
        <div class="customer-info mb-3">
          <strong>Customer:</strong> <span id="customerName"></span><br>
          <strong>Email:</strong> <span id="customerEmail"></span>
        </div>
        
        <!-- Email Status Cards -->
        <div class="email-status-container">
          <!-- Pending Email Card -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">Booking Received Email (Pending Status)</h6>
            </div>
            <div class="card-body">
              <div id="pendingEmailStatus">
                <!-- Dynamic content -->
              </div>
            </div>
          </div>
          
          <!-- Confirmed Email Card -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">Booking Confirmation Email</h6>
            </div>
            <div class="card-body">
              <div id="confirmedEmailStatus">
                <!-- Dynamic content -->
              </div>
            </div>
          </div>
          
          <!-- Cancelled Email Card -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">Booking Cancellation Email</h6>
            </div>
            <div class="card-body">
              <div id="cancelledEmailStatus">
                <!-- Dynamic content -->
              </div>
            </div>
          </div>
          <!-- Note: No reminder email card - only three email types -->
        </div>
        
        <!-- Send New Email Section -->
        <div class="send-email-section border-top pt-3">
          <h6>Send New Email</h6>
          <div class="form-group">
            <select class="form-control" id="emailTypeSelect">
              <option value="">Select email type...</option>
              <option value="booking_received">Pending Notification</option>
              <option value="booking_confirmed">Confirmation Email (with invoice)</option>
              <option value="booking_cancelled">Cancellation Email</option>
              <!-- No reminder email option -->
            </select>
          </div>
          <button class="btn btn-primary" onclick="sendNewEmail()">
            <i class="fa fa-paper-plane"></i> Send Email
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
```

### Status Display Template:

```javascript
function renderEmailStatus(emailType, logs) {
  if (!logs || logs.length === 0) {
    return `
      <div class="alert alert-secondary">
        <i class="fa fa-info-circle"></i> Not sent yet
        <button class="btn btn-sm btn-primary float-right" 
                onclick="sendEmail('${emailType}')">
          Send Now
        </button>
      </div>
    `;
  }
  
  const latestLog = logs[0];
  let statusHtml = '';
  
  switch (latestLog.status) {
    case 'sent':
      statusHtml = `
        <div class="alert alert-success">
          <i class="fa fa-check-circle"></i> 
          Sent successfully on ${formatDate(latestLog.created_at)}
          <br><small>To: ${latestLog.recipient_email}</small>
          ${latestLog.has_pdf ? '<br><small><i class="fa fa-paperclip"></i> Invoice attached</small>' : ''}
          <button class="btn btn-sm btn-outline-success float-right" 
                  onclick="resendEmail('${emailType}')">
            <i class="fa fa-redo"></i> Resend
          </button>
        </div>
      `;
      break;
      
    case 'failed':
      statusHtml = `
        <div class="alert alert-danger">
          <i class="fa fa-exclamation-circle"></i> 
          Failed on ${formatDate(latestLog.created_at)}
          <br><small>Error: ${latestLog.error_message}</small>
          <br><small>Attempts: ${latestLog.retry_count}</small>
          <button class="btn btn-sm btn-danger float-right" 
                  onclick="retryEmail('${emailType}')">
            <i class="fa fa-redo"></i> Retry
          </button>
        </div>
      `;
      break;
      
    case 'sending':
      statusHtml = `
        <div class="alert alert-warning">
          <i class="fa fa-spinner fa-spin"></i> 
          Currently sending...
        </div>
      `;
      break;
  }
  
  // Show history if multiple attempts
  if (logs.length > 1) {
    statusHtml += `
      <details class="mt-2">
        <summary>View History (${logs.length} attempts)</summary>
        <ul class="list-unstyled mt-2">
          ${logs.map(log => `
            <li>
              <small>
                ${formatDate(log.created_at)} - 
                <span class="badge badge-${getStatusColor(log.status)}">
                  ${log.status}
                </span>
                ${log.error_message ? `- ${log.error_message}` : ''}
              </small>
            </li>
          `).join('')}
        </ul>
      </details>
    `;
  }
  
  return statusHtml;
}
```

### Backend Enhancement for BookingController:

```php
public function getEmailStatus($id)
{
    $booking = Booking::with(['listing', 'category'])->findOrFail($id);
    
    // Get all email logs for this booking
    $emailLogs = EmailLog::where('booking_id', $id)
        ->orderBy('created_at', 'desc')
        ->get()
        ->groupBy('email_type');
    
    // Only three email types - no reminders
    $emailTypes = [
        'booking_received' => 'Pending Email',
        'booking_confirmed' => 'Confirmation Email', 
        'booking_cancelled' => 'Cancellation Email'
    ];
    
    $status = [];
    foreach ($emailTypes as $type => $label) {
        $logs = $emailLogs->get($type, collect())->map(function ($log) {
            return [
                'id' => $log->id,
                'status' => $log->status,
                'recipient_email' => $log->recipient_email,
                'created_at' => $log->created_at->toIso8601String(),
                'error_message' => $log->error_message,
                'retry_count' => $log->retry_count,
                'pdf_attached' => !empty($log->pdf_path)
            ];
        });
        
        $status[$type] = [
            'label' => $label,
            'logs' => $logs->toArray(),
            'can_send' => $this->canSendEmailType($booking, $type)
        ];
    }
    
    return response()->json([
        'booking' => [
            'id' => $booking->id,
            'customer_name' => $booking->name,
            'customer_email' => $booking->email,
            'status' => $booking->status
        ],
        'email_status' => $status
    ]);
}

public function retryEmail(Request $request, $id)
{
    $emailLogId = $request->email_log_id;
    $emailLog = EmailLog::findOrFail($emailLogId);
    
    // Check retry limit (configurable, default 3)
    $maxRetries = config('email.max_retries', 3);
    if ($emailLog->retry_count >= $maxRetries) {
        return response()->json([
            'success' => false,
            'message' => 'Maximum retry attempts reached'
        ], 400);
    }
    
    // Increment retry count
    $emailLog->increment('retry_count');
    
    // Add delay between retries if configured
    $retryDelay = config('email.retry_delay_seconds', 0);
    if ($retryDelay > 0 && $emailLog->retry_count > 1) {
        sleep($retryDelay);
    }
    
    // Attempt to resend
    $emailService = app(EmailServiceInterface::class);
    $success = $emailService->resend($emailLogId);
    
    return response()->json([
        'success' => $success,
        'message' => $success ? 'Email sent successfully' : 'Failed to send email'
    ]);
}

private function canSendEmailType(Booking $booking, string $emailType): bool
{
    // Business logic for when each email type can be sent
    switch ($emailType) {
        case 'booking_received':
            return $booking->status === 'Pending';
        case 'booking_confirmed':
            return $booking->status === 'Confirmed';
        case 'booking_cancelled':
            return $booking->status === 'Cancelled';
        default:
            return false;
    }
}
```

### JavaScript Functions:

```javascript
let currentBookingId = null;

function openEmailStatusModal(bookingId) {
  currentBookingId = bookingId;
  $('#emailStatusModal').modal('show');
  loadEmailStatus();
}

function loadEmailStatus() {
  $.ajax({
    url: `/admin/bookings/${currentBookingId}/email-status`,
    method: 'GET',
    success: function(data) {
      // Update customer info
      $('#bookingId').text(data.booking.id);
      $('#customerName').text(data.booking.customer_name);
      $('#customerEmail').text(data.booking.customer_email);
      
      // Update each email type status
      $('#pendingEmailStatus').html(
        renderEmailStatus('booking_received', data.email_status.booking_received.logs)
      );
      $('#confirmedEmailStatus').html(
        renderEmailStatus('booking_confirmed', data.email_status.booking_confirmed.logs)
      );
      $('#cancelledEmailStatus').html(
        renderEmailStatus('booking_cancelled', data.email_status.booking_cancelled.logs)
      );
    }
  });
}

function sendEmail(emailType, isResend = false) {
  const confirmMsg = isResend 
    ? 'This email was already sent. Do you want to send it again?' 
    : 'Send this email to the customer?';
    
  if (!confirm(confirmMsg)) return;
  
  $.ajax({
    url: `/admin/bookings/${currentBookingId}/send-email`,
    method: 'POST',
    data: { 
      email_type: emailType,
      _token: $('meta[name="csrf-token"]').attr('content')
    },
    beforeSend: function() {
      // Show loading state
      $(`#${emailType}Status`).html('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Sending...</div>');
    },
    success: function(data) {
      toastr.success('Email sent successfully!');
      loadEmailStatus(); // Refresh the status
    },
    error: function(xhr) {
      toastr.error('Failed to send email: ' + xhr.responseJSON.message);
      loadEmailStatus(); // Refresh to show error
    }
  });
}

function resendEmail(emailType) {
  sendEmail(emailType, true);
}

function retryEmail(emailType) {
  sendEmail(emailType, false);
}
```

### File Locations

- Create: `resources/views/bookings/modals/email-status.blade.php` - Modal template
- Update: `resources/views/bookings/list.blade.php` - Include modal
- Update: `app/Http/Controllers/BookingController.php` - Enhanced methods
- Create: `public/js/email-status.js` - JavaScript logic
- Update: `routes/web.php` - Add retry route (verify existing structure)
- Update: `config/email.php` - Add retry configuration options

### Testing Requirements

- Test with bookings that have no email history
- Test with bookings that have multiple send attempts
- Test retry functionality with failed emails (max 3 attempts)
- Test resend functionality with sent emails
- Verify real-time updates work correctly
- Test error display for various failure types
- Verify PDF attachment indicator for confirmed bookings
- Test with only three email types (no reminders)
- Verify retry delay configuration works

### Technical Constraints

- Maximum retry attempts configurable (default 3)
- Configurable delay between retry attempts
- Must handle concurrent email sending
- Dialog should not block other operations
- Must work with existing email queue system
- PDF generation only for confirmed bookings
- Support only three email types (no reminders)

### Integration Verification

- IV1: Dialog displays complete email history
- IV2: Status colors match email states
- IV3: Retry/resend functions work correctly
- IV4: Real-time updates reflect new status
- IV5: Error messages are user-friendly

## Change Log

| Date       | Version | Description                          | Author       |
|------------|---------|--------------------------------------|--------------|
| 2025-08-06 | 1.0     | Initial story creation               | Scrum Master |

## Dev Agent Record

### Agent Model Used
[To be filled by implementing agent]

### Debug Log References
[To be filled during implementation]

### Completion Notes List
[To be filled during implementation]

### File List
[To be filled with actual created/modified files]

## QA Results

[To be completed after implementation]